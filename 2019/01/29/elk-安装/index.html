<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>elk 安装 | Dalioer&#39;s website</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="elk 安装服务器端生成证书服务端vim /etc/pki/tls/openssl.cnf  在[ v3_ca ]下添加如下内容12#subjectAltName = IP: 服务器ip地址subjectAltName = IP: 127.0.0.1 生成证书1openssl req -config /etc/pki/tls/openssl.cnf -x509 -days 3650 -batch">
<meta property="og:type" content="article">
<meta property="og:title" content="elk 安装">
<meta property="og:url" content="https://dalioer.github.io/dalioer/2019/01/29/elk-安装/index.html">
<meta property="og:site_name" content="Dalioer&#39;s website">
<meta property="og:description" content="elk 安装服务器端生成证书服务端vim /etc/pki/tls/openssl.cnf  在[ v3_ca ]下添加如下内容12#subjectAltName = IP: 服务器ip地址subjectAltName = IP: 127.0.0.1 生成证书1openssl req -config /etc/pki/tls/openssl.cnf -x509 -days 3650 -batch">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-29T08:44:25.858Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="elk 安装">
<meta name="twitter:description" content="elk 安装服务器端生成证书服务端vim /etc/pki/tls/openssl.cnf  在[ v3_ca ]下添加如下内容12#subjectAltName = IP: 服务器ip地址subjectAltName = IP: 127.0.0.1 生成证书1openssl req -config /etc/pki/tls/openssl.cnf -x509 -days 3650 -batch">
  
    <link rel="alternate" href="/dalioer/atom.xml" title="Dalioer&#39;s website" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/dalioer/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/dalioer/" id="logo">Dalioer&#39;s website</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/dalioer/">Home</a>
        
          <a class="main-nav-link" href="/dalioer/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/dalioer/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dalioer.github.io/dalioer"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-elk-安装" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/dalioer/2019/01/29/elk-安装/" class="article-date">
  <time datetime="2019-01-29T08:29:38.000Z" itemprop="datePublished">2019-01-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      elk 安装
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="elk-安装"><a href="#elk-安装" class="headerlink" title="elk 安装"></a>elk 安装</h1><h2 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h2><h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><p>服务端<br><code>vim /etc/pki/tls/openssl.cnf</code>  在<code>[ v3_ca ]</code>下添加如下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#subjectAltName = IP: 服务器ip地址</span><br><span class="line">subjectAltName = IP: 127.0.0.1</span><br></pre></td></tr></table></figure></p>
<p>生成证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -config /etc/pki/tls/openssl.cnf -x509 -days 3650 -batch -nodes -newkey rsa:2048 -keyout /etc/pki/tls/private/logstash-forwarder.key -out /etc/pki/tls/certs/logstash-forwarder.crt</span><br></pre></td></tr></table></figure></p>
<h3 id="配置logstash"><a href="#配置logstash" class="headerlink" title="配置logstash"></a>配置logstash</h3><p>logstash 配置文件所在路径<code>/etc/logstash/conf.d/logstash.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">    #证书配置</span><br><span class="line">    ssl =&gt; true</span><br><span class="line">    ssl_certificate =&gt; &quot;/etc/pki/tls/certs/logstash-forwarder.crt&quot;</span><br><span class="line">    ssl_key =&gt; &quot;/etc/pki/tls/private/logstash-forwarder.key&quot;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line"> if &quot;dalioer.github.io&quot; in [tags] &#123;</span><br><span class="line">       grok &#123;</span><br><span class="line">              #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:remote_addr&#125; (?:%&#123;DATA:remote_user&#125;|-) \[%&#123;HTTPDATE:timestamp&#125;\] %&#123;IPORHOST:http_host&#125; %&#123;DATA:request_method&#125; %&#123;DATA:request_uri&#125; %&#123;NUMBER:status&#125; (?:%&#123;NUMBER:body_bytes_sent&#125;|-) (?:%&#123;DATA:request_time&#125;|-) \&quot;(?:%&#123;DATA:http_referer&#125;|-)\&quot; \&quot;%&#123;DATA:http_user_agent&#125;\&quot; (?:%&#123;DATA:http_x_forwarded_for&#125;|-) \&quot;(?:%&#123;DATA:http_cookie&#125;|-)\&quot;&quot;&#125;</span><br><span class="line">	      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:remote_addr&#125; (?:%&#123;DATA:remote_user&#125;|-) \[%&#123;HTTPDATE:timestamp&#125;\] %&#123;IPORHOST:http_host&#125; %&#123;DATA:request_method&#125; \&quot;%&#123;DATA:request_uri&#125;\&quot; %&#123;NUMBER:status&#125; (?:%&#123;NUMBER:body_bytes_sent&#125;|-) (?:%&#123;DATA:request_time&#125;|-) \&quot;(?:%&#123;DATA:http_referer&#125;|-)\&quot; \&quot;%&#123;DATA:http_user_agent&#125;\&quot; \&quot;(?:%&#123;DATA:http_x_forwarded_for&#125;|-)\&quot; \&quot;(?:%&#123;DATA:http_cookie&#125;|-)\&quot;&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">                convert =&gt; [&quot;status&quot;,&quot;integer&quot;]</span><br><span class="line">                convert =&gt; [&quot;body_bytes_sent&quot;,&quot;integer&quot;]</span><br><span class="line">                convert =&gt; [&quot;request_time&quot;,&quot;float&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        geoip &#123;</span><br><span class="line">                source=&gt;&quot;remote_addr&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        date &#123;</span><br><span class="line">                match =&gt; [ &quot;timestamp&quot;,&quot;dd/MMM/YYYY:HH:mm:ss Z&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        useragent &#123;</span><br><span class="line">                source=&gt;&quot;http_user_agent&quot;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  #elasticsearch &#123;</span><br><span class="line">    #index =&gt; &quot;filebeat-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    #index =&gt; &quot;filebeat-%&#123;[fields][log_type]&#125;%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    #es地址</span><br><span class="line">    #hosts =&gt; [&quot;http://10.248.36.161:8082&quot;]</span><br><span class="line">    #user =&gt; &quot;elastic&quot;</span><br><span class="line">    #password =&gt; &quot;changeme&quot;</span><br><span class="line">  #&#125;</span><br><span class="line">  # 使用geoip,index必须以logstash-开头</span><br><span class="line">    #index建议用logstash-开头，以匹配默认模版</span><br><span class="line">    if &quot;dalioer.github.io&quot; in [tags] &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">                #manage_template =&gt; true</span><br><span class="line">                #template_overwrite =&gt; true</span><br><span class="line">                #template =&gt; &quot;/data/elk/logstash/config/logstash.json&quot;</span><br><span class="line">                hosts =&gt; [&quot;http://10.248.36.161:9200&quot;,&quot;http://10.248.36.162:9200&quot;]</span><br><span class="line">                #index =&gt; &quot;logstash-nginx-access-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">                #按周创建index</span><br><span class="line">                index =&gt; &quot;logstash-nginx-access-%&#123;+YYYY.ww&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if &quot;test&quot; in [tags] &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">                #manage_template =&gt; true</span><br><span class="line">                #template_overwrite =&gt; true</span><br><span class="line">                #template =&gt; &quot;/data/elk/logstash/config/logstash.json&quot;</span><br><span class="line">                hosts =&gt; [&quot;http://10.248.36.161:9200&quot;,&quot;http://10.248.36.162:9200&quot;]</span><br><span class="line">                #按月创建index</span><br><span class="line">                index =&gt; &quot;logstash-test-%&#123;[fields][log_type]&#125;-%&#123;+YYYY.MM&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">                #manage_template =&gt; true</span><br><span class="line">                #template_overwrite =&gt; true</span><br><span class="line">                #template =&gt; &quot;/data/elk/logstash/config/logstash.json&quot;</span><br><span class="line">                hosts =&gt; [&quot;http://10.248.36.161:9200&quot;,&quot;http://10.248.36.162:9200&quot;]</span><br><span class="line">                #index =&gt; &quot;filebeat-%&#123;[fields][log_type]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">                #按周创建index</span><br><span class="line">                index =&gt; &quot;logstash-%&#123;[fields][log_type]&#125;-%&#123;+YYYY.ww&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    #user =&gt; &quot;elastic&quot;</span><br><span class="line">    #password =&gt; &quot;changeme&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置logstash es 索引分片,默认情况下为5个分片，每天每个日志一个index，那一共就是5个分片，10多个日志180天分片将达到18000个，分片数过多影响es性能。自定义模版调整<code>index.number_of_shards</code> 为合适值，在logstash配置中指定template即可。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">  <span class="attr">"template"</span> : <span class="string">"crawl-*"</span>,  </span><br><span class="line">  <span class="attr">"settings"</span> : &#123;  </span><br><span class="line">   <span class="attr">"index.number_of_shards"</span>: <span class="number">2</span>,  </span><br><span class="line">   <span class="attr">"number_of_replicas"</span>: <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">&#125;,  </span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;  </span><br><span class="line">    <span class="attr">"_default_"</span> : &#123;  </span><br><span class="line">      <span class="attr">"_all"</span> : &#123;<span class="attr">"enabled"</span> : <span class="literal">true</span>, <span class="attr">"omit_norms"</span> : <span class="literal">true</span>&#125;,  </span><br><span class="line">      <span class="attr">"dynamic_templates"</span> : [ &#123;  </span><br><span class="line">        <span class="attr">"message_field"</span> : &#123;  </span><br><span class="line">          <span class="attr">"match"</span> : <span class="string">"message"</span>,  </span><br><span class="line">          <span class="attr">"match_mapping_type"</span> : <span class="string">"string"</span>,  </span><br><span class="line">          <span class="attr">"mapping"</span> : &#123;  </span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"string"</span>, <span class="attr">"index"</span> : <span class="string">"analyzed"</span>, <span class="attr">"omit_norms"</span> : <span class="literal">true</span>,  </span><br><span class="line">            <span class="attr">"fielddata"</span> : &#123; <span class="attr">"format"</span> : <span class="string">"disabled"</span> &#125;  </span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;, &#123;  </span><br><span class="line">        <span class="attr">"string_fields"</span> : &#123;  </span><br><span class="line">          <span class="attr">"match"</span> : <span class="string">"*"</span>,  </span><br><span class="line">          <span class="attr">"match_mapping_type"</span> : <span class="string">"string"</span>,  </span><br><span class="line">          <span class="attr">"mapping"</span> : &#123;  </span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"string"</span>, <span class="attr">"index"</span> : <span class="string">"not_analyzed"</span>, <span class="attr">"doc_values"</span> : <span class="literal">true</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125; ],  </span><br><span class="line">      <span class="attr">"properties"</span> : &#123;  </span><br><span class="line">        <span class="attr">"@timestamp"</span>: &#123; <span class="attr">"type"</span>: <span class="string">"date"</span> &#125;,  </span><br><span class="line">        <span class="attr">"@version"</span>: &#123; <span class="attr">"type"</span>: <span class="string">"string"</span>, <span class="attr">"index"</span>: <span class="string">"not_analyzed"</span> &#125;,  </span><br><span class="line">        <span class="attr">"geoip"</span>  : &#123;  </span><br><span class="line">          <span class="attr">"dynamic"</span>: <span class="literal">true</span>,  </span><br><span class="line">          <span class="attr">"properties"</span> : &#123;  </span><br><span class="line">            <span class="attr">"ip"</span>: &#123; <span class="attr">"type"</span>: <span class="string">"ip"</span> &#125;,  </span><br><span class="line">            <span class="attr">"location"</span> : &#123; <span class="attr">"type"</span> : <span class="string">"geo_point"</span> &#125;,  </span><br><span class="line">            <span class="attr">"latitude"</span> : &#123; <span class="attr">"type"</span> : <span class="string">"float"</span> &#125;,  </span><br><span class="line">            <span class="attr">"longitude"</span> : &#123; <span class="attr">"type"</span> : <span class="string">"float"</span> &#125;  </span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>grok匹配nginx日志，nginx日志格式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log_format  kirito  &apos;$remote_addr $remote_user [$time_local] $http_host $request_method &quot;$uri&quot; $status &apos;</span><br><span class="line">              &apos;$body_bytes_sent $request_time &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$http_cookie&quot;&apos; ;</span><br></pre></td></tr></table></figure></p>
<h2 id="客户端服务器"><a href="#客户端服务器" class="headerlink" title="客户端服务器"></a>客户端服务器</h2><h3 id="安装filebeat"><a href="#安装filebeat" class="headerlink" title="安装filebeat"></a>安装filebeat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Debian/Ubuntu:</span></span><br><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.5.4-amd64.deb</span><br><span class="line">sudo dpkg -i filebeat-6.5.4-amd64.deb</span><br><span class="line"><span class="comment">#Redhat/Centos/Fedora:</span></span><br><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.5.4-x86_64.rpm</span><br><span class="line">sudo rpm -vi filebeat-6.5.4-x86_64.rpm</span><br><span class="line"></span><br><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.3.2-x86_64.rpm</span><br><span class="line">sudo rpm -vi filebeat-5.3.2-x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>配置filebeat （默认文件路径 /etc/filebeat/filebeat.yml）<br>上传生成的证书cert到客户端filebeat</p>
<h4 id="filebeat5-x配置"><a href="#filebeat5-x配置" class="headerlink" title="filebeat5.x配置"></a>filebeat5.x配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">filebeat.prospectors:</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/usr/local/nginx/logs/*.log</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">nginx-access</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">["dalioer.github.io"]</span></span><br><span class="line">  <span class="comment">#添加tags用来在logstash中匹配</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/app/apache-tomcat/logs/catalina.out</span></span><br><span class="line">  <span class="comment"># 匹配tomcat日志，多行为一行</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line">    <span class="comment">#匹配日期格式2018-12-04</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  exclude_lines:</span> <span class="string">["create</span> <span class="string">account</span> <span class="string">failed"]</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">tomcat-out</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/app/apache-tomcat/logs/TFCF_port*</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">tomtfcf</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/app/apaina.out</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">tomt</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/logs/TForm*</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">tomtfcf</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/provider-xw.log</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">apir-xw</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/handle-notify.log</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">hanotify</span></span><br><span class="line"><span class="attr">- paths:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/data/notify.log</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">apiotify</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------- Logstash output --------------------------------</span></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["127.0.0.1:8081"]</span></span><br><span class="line">  <span class="comment">#证书配置</span></span><br><span class="line">  <span class="string">ssl.certificate_authorities:</span> <span class="string">["/etc/pki/tls/certs/logstash-forwarder.crt"]</span></span><br><span class="line"><span class="attr">  compression:</span> <span class="string">gzip</span></span><br></pre></td></tr></table></figure>
<h4 id="filebeat6-x配置"><a href="#filebeat6-x配置" class="headerlink" title="filebeat6.x配置"></a>filebeat6.x配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/opt/logs/app.20190123.log</span></span><br><span class="line">  <span class="comment">#exclude_lines: ['^DBG']</span></span><br><span class="line">  <span class="comment">#include_lines: ['^ERR', '^WARN']</span></span><br><span class="line"><span class="attr">  exclude_files:</span> <span class="string">['.gz$']</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">super-m</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">["test"]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">### Multiline options</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line">    <span class="comment">#匹配日期格式2018-12-04</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/opt/logs/after.20190124.log</span> </span><br><span class="line"><span class="attr">  exclude_files:</span> <span class="string">['.gz$']</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    log_type:</span> <span class="string">super-n</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">["test"]</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line">    <span class="comment">#匹配日期格式2018-12-04</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;'</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">    <span class="comment">#max_lines: 500</span></span><br><span class="line"><span class="comment">#============================= Filebeat modules ===============================</span></span><br><span class="line"></span><br><span class="line"><span class="string">filebeat.config.modules:</span></span><br><span class="line">  <span class="comment"># Glob pattern for configuration loading</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Set to true to enable config reloading</span></span><br><span class="line">  <span class="string">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Period on which files under path should be checked for changes</span></span><br><span class="line">  <span class="comment">#reload.period: 10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#==================== Elasticsearch template setting ==========================</span></span><br><span class="line"></span><br><span class="line"><span class="string">setup.template.settings:</span></span><br><span class="line">  <span class="string">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment">#index.codec: best_compression</span></span><br><span class="line">  <span class="comment">#_source.enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ General =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The name of the shipper that publishes the network data. It can be used to group</span></span><br><span class="line"><span class="comment"># all the transactions sent by a single shipper in the web interface.</span></span><br><span class="line"><span class="comment">#name:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The tags of the shipper are included in their own field with each</span></span><br><span class="line"><span class="comment"># transaction published.</span></span><br><span class="line"><span class="comment">#tags: ["service-X", "web-tier"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional fields that you can specify to add additional information to the</span></span><br><span class="line"><span class="comment"># output.</span></span><br><span class="line"><span class="comment">#fields:</span></span><br><span class="line"><span class="comment">#  env: staging</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== Dashboards =====================================</span></span><br><span class="line"><span class="comment"># These settings control loading the sample dashboards to the Kibana index. Loading</span></span><br><span class="line"><span class="comment"># the dashboards is disabled by default and can be enabled either by setting the</span></span><br><span class="line"><span class="comment"># options here, or by using the `-setup` CLI flag or the `setup` command.</span></span><br><span class="line"><span class="comment">#setup.dashboards.enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The URL from where to download the dashboards archive. By default this URL</span></span><br><span class="line"><span class="comment"># has a value which is computed based on the Beat name and version. For released</span></span><br><span class="line"><span class="comment"># versions, this URL points to the dashboard archive on the artifacts.elastic.co</span></span><br><span class="line"><span class="comment"># website.</span></span><br><span class="line"><span class="comment">#setup.dashboards.url:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== Kibana =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.</span></span><br><span class="line"><span class="comment"># This requires a Kibana endpoint configuration.</span></span><br><span class="line"><span class="string">setup.kibana:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Kibana Host</span></span><br><span class="line">  <span class="comment"># Scheme and port can be left out and will be set to the default (http and 5601)</span></span><br><span class="line">  <span class="comment"># In case you specify and additional path, the scheme is required: http://localhost:5601/path</span></span><br><span class="line">  <span class="comment"># IPv6 addresses should always be defined as: https://[2001:db8::1]:5601</span></span><br><span class="line">  <span class="comment">#host: "localhost:5601"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Kibana Space ID</span></span><br><span class="line">  <span class="comment"># ID of the Kibana Space into which the dashboards should be loaded. By default,</span></span><br><span class="line">  <span class="comment"># the Default Space will be used.</span></span><br><span class="line">  <span class="comment">#space.id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================= Elastic Cloud ==================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These settings simplify using filebeat with the Elastic Cloud (https://cloud.elastic.co/).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The cloud.id setting overwrites the `output.elasticsearch.hosts` and</span></span><br><span class="line"><span class="comment"># `setup.kibana.host` options.</span></span><br><span class="line"><span class="comment"># You can find the `cloud.id` in the Elastic Cloud web UI.</span></span><br><span class="line"><span class="comment">#cloud.id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The cloud.auth setting overwrites the `output.elasticsearch.username` and</span></span><br><span class="line"><span class="comment"># `output.elasticsearch.password` settings. The format is `&lt;user&gt;:&lt;pass&gt;`.</span></span><br><span class="line"><span class="comment">#cloud.auth:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure what output to use when sending the data collected by the beat.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------- Elasticsearch output ------------------------------</span></span><br><span class="line"><span class="comment">#output.elasticsearch:</span></span><br><span class="line">  <span class="comment"># Array of hosts to connect to.</span></span><br><span class="line">  <span class="comment">#hosts: ["localhost:9200"]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Optional protocol and basic auth credentials.</span></span><br><span class="line">  <span class="comment">#protocol: "https"</span></span><br><span class="line">  <span class="comment">#username: "elastic"</span></span><br><span class="line">  <span class="comment">#password: "changeme"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------- Logstash output --------------------------------</span></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line">  <span class="comment"># The Logstash hosts</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["127.0.0.1:22225"]</span></span><br><span class="line"><span class="attr">  compression:</span> <span class="string">gzip</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Optional SSL. By default is off.</span></span><br><span class="line">  <span class="comment"># List of root certificates for HTTPS server verifications</span></span><br><span class="line">  <span class="comment">#ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Certificate for SSL client authentication</span></span><br><span class="line">  <span class="comment">#ssl.certificate: "/etc/pki/client/cert.pem"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Client Certificate Key</span></span><br><span class="line">  <span class="comment">#ssl.key: "/etc/pki/client/cert.key"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Procesors =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure processors to enhance or manipulate events generated by the beat.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="attr">  - add_host_metadata:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  - add_cloud_metadata:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Logging =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets log level. The default log level is info.</span></span><br><span class="line"><span class="comment"># Available log levels are: error, warning, info, debug</span></span><br><span class="line"><span class="comment">#logging.level: debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># At debug level, you can selectively enable logging only for some components.</span></span><br><span class="line"><span class="comment"># To enable all selectors use ["*"]. Examples of other selectors are "beat",</span></span><br><span class="line"><span class="comment"># "publish", "service".</span></span><br><span class="line"><span class="comment">#logging.selectors: ["*"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== Xpack Monitoring ===============================</span></span><br><span class="line"><span class="comment"># filebeat can export internal metrics to a central Elasticsearch monitoring</span></span><br><span class="line"><span class="comment"># cluster.  This requires xpack monitoring to be enabled in Elasticsearch.  The</span></span><br><span class="line"><span class="comment"># reporting is disabled by default.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set to true to enable the monitoring reporter.</span></span><br><span class="line"><span class="comment">#xpack.monitoring.enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment to send the metrics to Elasticsearch. Most settings from the</span></span><br><span class="line"><span class="comment"># Elasticsearch output are accepted here as well. Any setting that is not set is</span></span><br><span class="line"><span class="comment"># automatically inherited from the Elasticsearch output configuration, so if you</span></span><br><span class="line"><span class="comment"># have the Elasticsearch output configured, you can simply uncomment the</span></span><br><span class="line"><span class="comment"># following line.</span></span><br><span class="line"><span class="comment">#xpack.monitoring.elasticsearch:</span></span><br></pre></td></tr></table></figure>
<ul>
<li>paths 需要收集的日志文件路径</li>
<li>hosts: logstash 服务IP和端口</li>
</ul>
<p>测试配置文件语法是否正确</p>
<p><code>/usr/bin/filebeat.sh -configtest /etc/filebeat/filebeat.yml</code></p>
<p>修改完成后，重启filebeat<br><code>/etc/init.d/filebeat restart</code></p>
<h3 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h3><p>配置<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Elasticsearch comes with reasonable defaults for most settings.</span></span><br><span class="line"><span class="comment">#       Before you set out to tweak and tune the configuration, make sure you</span></span><br><span class="line"><span class="comment">#       understand what are you trying to accomplish and the consequences.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The primary way of configuring a node is via this file. This template lists</span></span><br><span class="line"><span class="comment"># the most important settings you may want to configure for a production cluster.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please consult the documentation for further information on configuration options:</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">node.name:</span> <span class="number">10.248</span><span class="number">.36</span><span class="number">.162</span></span><br><span class="line"><span class="comment">#若节点为master 则设置为true</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Add custom attributes to the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">path.data:</span> <span class="string">/data/elk/elasticsearch</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">path.logs:</span> <span class="string">/data/elk/elasticsearch/logs</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lock the memory on startup:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">bootstrap.memory_lock:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">bootstrap.system_call_filter:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make sure that the heap size is set to about half the memory available</span></span><br><span class="line"><span class="comment"># on the system and that the owner of the process is allowed to use this</span></span><br><span class="line"><span class="comment"># limit.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Elasticsearch performs poorly when the system is swapping the memory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">10.248</span><span class="number">.36</span><span class="number">.162</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the network module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Pass an initial list of hosts to perform discovery when new node is started:</span></span><br><span class="line"><span class="comment"># The default list of hosts is ["127.0.0.1", "[::1]"]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#discovery.zen.ping.unicast.hosts: ["host1", "host2"]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Prevent the "split brain" by configuring the majority of nodes (total number of master-eligible nodes / 2 + 1):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#discovery.zen.minimum_master_nodes: 3</span></span><br><span class="line"><span class="string">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span> <span class="string">["10.248.36.161","10.248.36.162"]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the zen discovery module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the gateway module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Various -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Require explicit names when deleting indices:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># xpack </span></span><br><span class="line"><span class="string">xpack.ml.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">xpack.security.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">xpack.monitoring.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">xpack.graph.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">xpack.watcher.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>以上为常用的配置选项，还有一些选项为默认开启，在配置文件中未显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.number_of_shards: 3 #设置索引分片个数分3，默认为5片</span><br><span class="line">index.number_of_replicas: 1 #副本备份数量为1</span><br></pre></td></tr></table></figure></p>
<h3 id="kibana-禁用xpack"><a href="#kibana-禁用xpack" class="headerlink" title="kibana 禁用xpack"></a>kibana 禁用xpack</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xpack.ml.enabled: false</span><br><span class="line">xpack.security.enabled: false</span><br><span class="line">xpack.monitoring.enabled: false</span><br></pre></td></tr></table></figure>
<h3 id="访问kibana页面"><a href="#访问kibana页面" class="headerlink" title="访问kibana页面"></a>访问kibana页面</h3><p>在已经安装filebeat的客户端服务器上，测试日志收集</p>
<p><code>echo &#39;test log ......&#39; &gt;&gt; /data/logs/info.log</code></p>
<p>在浏览器输入 localhost:5601（IP修改为ELK所在服务器的IP地址）创建默认的索引后，可以在web上看到输入的测试日志。</p>
<p>因为ES保存日志是永久保存，所以需要定期删除一下日志，下面命令为删除指定时间前的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://xx.xx.com:9200/logstash-*-`date +%Y-%m-%d -d &quot;-$n days&quot;`</span><br></pre></td></tr></table></figure></p>
<p>查看index</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200/_cat/indices?v</span><br></pre></td></tr></table></figure>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="elasticearch-index问题"><a href="#elasticearch-index问题" class="headerlink" title="elasticearch index问题"></a>elasticearch index问题</h4><p>由于日志文件有filebeat统一发送至logstash,无法区分每个应用产生的日志，需要在filebeat上加上<code>fields</code>配置，内容自定义如上面的是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- paths:</span><br><span class="line">  - /data/depository/tianfu-depository-handle-notify/logs/tianfu-depository-handle-notify.log</span><br><span class="line">  fields:</span><br><span class="line">    log_type: handle-notify</span><br></pre></td></tr></table></figure></p>
<p>加上后在logstash中output可以使用<code>%{[fields][log_type]}</code>来创建index进而区分，不同日志</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dalioer.github.io/dalioer/2019/01/29/elk-安装/" data-id="cjrhiwo8w0002w4pvkf16604c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/dalioer/2019/01/29/elasticsearch语法/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          elasticsearch语法
        
      </div>
    </a>
  
  
    <a href="/dalioer/2019/01/29/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/dalioer/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/dalioer/2019/01/29/elasticsearch语法/">elasticsearch语法</a>
          </li>
        
          <li>
            <a href="/dalioer/2019/01/29/elk-安装/">elk 安装</a>
          </li>
        
          <li>
            <a href="/dalioer/2019/01/29/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Dalioer<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/dalioer/" class="mobile-nav-link">Home</a>
  
    <a href="/dalioer/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/dalioer/fancybox/jquery.fancybox.css">
  <script src="/dalioer/fancybox/jquery.fancybox.pack.js"></script>


<script src="/dalioer/js/script.js"></script>



  </div>
</body>
</html>